apiVersion: v1
kind: ConfigMap
metadata:
  name: actualbudget-backup-script
  namespace: actualbudget
  labels:
    app.kubernetes.io/name: actualbudget
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: homelab
data:
  backup.sh: |
    #!/bin/bash
    set -euo pipefail

    echo "========================================="
    echo "ActualBudget Backup Started"
    echo "Timestamp: $(date -u +%Y-%m-%d_%H-%M-%S)"
    echo "========================================="

    # Install required tools (tar not included in azure-cli image)
    echo "Installing required tools..."
    apk add --no-cache tar gzip

    # Variables
    TIMESTAMP=$(date -u +%Y-%m-%d_%H-%M-%S)
    BACKUP_FILE="${BACKUP_PREFIX}-${TIMESTAMP}.tar.gz"
    TEMP_BACKUP="/tmp/${BACKUP_FILE}"

    # Step 1: Create compressed archive
    echo "Creating compressed archive of /data..."
    cd /data
    tar -czf "${TEMP_BACKUP}" .

    # Get file size
    BACKUP_SIZE=$(du -h "${TEMP_BACKUP}" | cut -f1)
    echo "Backup archive created: ${BACKUP_FILE} (${BACKUP_SIZE})"

    # Step 2: Upload to Azure Blob Storage
    echo "Uploading backup to Azure Blob Storage..."
    az storage blob upload \
      --connection-string "${AZURE_STORAGE_CONNECTION_STRING}" \
      --container-name "${CONTAINER_NAME}" \
      --file "${TEMP_BACKUP}" \
      --name "${BACKUP_FILE}" \
      --overwrite false

    echo "Upload successful: ${BACKUP_FILE}"

    # Step 3: Cleanup old backups (keep last N backups)
    echo "Cleaning up old backups (keeping last ${BACKUP_RETENTION_COUNT})..."

    # List all backups, sort by name (timestamp based), get all except last N
    az storage blob list \
      --connection-string "${AZURE_STORAGE_CONNECTION_STRING}" \
      --container-name "${CONTAINER_NAME}" \
      --prefix "${BACKUP_PREFIX}-" \
      --query "[].name" \
      --output tsv | \
    sort -r | \
    tail -n +$((BACKUP_RETENTION_COUNT + 1)) | \
    while read -r OLD_BACKUP; do
      if [ -n "$OLD_BACKUP" ]; then
        echo "Deleting old backup: ${OLD_BACKUP}"
        az storage blob delete \
          --connection-string "${AZURE_STORAGE_CONNECTION_STRING}" \
          --container-name "${CONTAINER_NAME}" \
          --name "${OLD_BACKUP}"
      fi
    done

    # Step 4: List current backups
    echo ""
    echo "Current backups in storage:"
    az storage blob list \
      --connection-string "${AZURE_STORAGE_CONNECTION_STRING}" \
      --container-name "${CONTAINER_NAME}" \
      --prefix "${BACKUP_PREFIX}-" \
      --query "[].{Name:name, Size:properties.contentLength, Modified:properties.lastModified}" \
      --output table

    # Cleanup temp file
    rm -f "${TEMP_BACKUP}"

    echo ""
    echo "========================================="
    echo "Backup completed successfully!"
    echo "========================================="
